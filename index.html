<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Полноэкранный Редактор Python с Pyodide</title>
    <!-- Подключение Tailwind CSS через CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <!-- Подключение CSS для автодополнения -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">
    <!-- Подключение Droid Sans Mono шрифта -->
    <link href="https://fonts.googleapis.com/css2?family=Droid+Sans+Mono&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Droid Sans Mono', monospace;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Темная тема */
        .dark {
            background-color: #202124;
            color: #e8eaed;
        }
        /* Светлая тема */
        .light {
            background-color: #ffffff;
            color: #202124;
        }
        /* Полноэкранный контейнер редактора */
        .editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 10px;
            background-color: #303134;
            transition: background-color 0.3s;
        }
        .light .editor-container {
            background-color: #f1f3f4;
        }
        /* Настройки для CodeMirror */
        .CodeMirror {
            flex: 1;
            border: 1px solid #5f6368;
            border-radius: 8px;
            font-family: 'Droid Sans Mono', monospace;
            font-size: 16px;
            height: auto;
        }
        .light .CodeMirror {
            border: 1px solid #ced4da;
        }
        /* Обеспечение адаптивности CodeMirror */
        .CodeMirror-scroll {
            max-height: 100%;
        }
        /* Стили для модального окна */
        .modal {
            display: none; /* Скрыто по умолчанию */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s;
        }
        .modal.active {
            display: block;
        }
        .modal-content {
            background-color: inherit;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
        }
        /* Стили для окна результатов */
        .output {
            background-color: #202124; /* Тёмная тема по умолчанию */
            color: #e8eaed;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .light .output {
            background-color: #f1f3f4;
            color: #202124;
        }
    </style>
</head>
<body class="dark">
    <!-- Контейнер редактора -->
    <div class="editor-container">
        <!-- Навигационная панель (Toolbar) -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
            <div class="flex flex-wrap gap-2 mb-2 md:mb-0">
                <button id="run-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded">Выполнить</button>
                <button id="screenshot-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded">Скриншот</button>
                <button id="share-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded">Поделиться</button>
                <button id="download-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded">Скачать</button>
                <button id="load-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded">Загрузить</button>
                <input type="file" id="file-input" accept=".py" style="display:none;">
            </div>
            <button id="theme-toggle" class="border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 font-semibold py-2 px-4 rounded">Светлый режим</button>
        </div>

        <!-- Редактор кода -->
        <textarea id="editor"># Напишите ваш код здесь
print("Hello, Pyodide!")</textarea>
    </div>

    <!-- Модальное окно для вывода результата -->
    <div id="outputModal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 rounded shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Результат</h2>
                <button id="closeModal" class="text-gray-800 dark:text-gray-200">&times;</button>
            </div>
            <pre id="output" class="output"></pre>
            <div class="flex justify-end mt-4">
                <button id="closeModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Подключение необходимых скриптов -->
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.0/full/pyodide.js"></script>
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <!-- Добавление автодополнения CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/anyword-hint.min.js"></script>
    <!-- Добавление автозакрытия кавычек и скобок -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <!-- html2canvas для скриншотов -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Список Python-ключевых слов и встроенных функций для автодополнения
        const pythonKeywords = [
            "False", "None", "True", "and", "as", "assert", "async", "await",
            "break", "class", "continue", "def", "del", "elif", "else", "except",
            "finally", "for", "from", "global", "if", "import", "in", "is",
            "lambda", "nonlocal", "not", "or", "pass", "raise", "return",
            "try", "while", "with", "yield"
        ];

        const pythonBuiltins = [
            "abs", "dict", "help", "min", "setattr", "all", "dir", "hex",
            "next", "slice", "any", "divmod", "id", "object", "sorted",
            "ascii", "enumerate", "input", "oct", "staticmethod", "bin",
            "eval", "int", "open", "str", "bool", "exec", "isinstance",
            "ord", "sum", "bytearray", "filter", "issubclass", "pow",
            "super", "bytes", "float", "iter", "print", "tuple", "callable",
            "format", "len", "property", "type", "chr", "frozenset", "list",
            "range", "vars", "classmethod", "getattr", "locals", "repr",
            "zip", "compile", "globals", "map", "reversed", "__import__",
            "complex", "hasattr", "max", "round", "delattr", "hash", "memoryview",
            "set"
        ];

        // Инициализация CodeMirror с автодополнением и автозакрытием скобок
        const textarea = document.getElementById('editor');
        const editor = CodeMirror.fromTextArea(textarea, {
            lineNumbers: true,
            mode: 'python',
            theme: 'dracula', // Тёмная тема
            autofocus: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: true,
            autoCloseBrackets: true, // Включение автозакрытия скобок и кавычек
            extraKeys: {
                "F11": function(cm) { toggleFullScreen(); },
                "Esc": function(cm) { if (isFullScreen()) toggleFullScreen(); }
            },
            hintOptions: {
                hint: function(cm) {
                    const cur = cm.getCursor();
                    const token = cm.getTokenAt(cur);
                    const start = token.start;
                    const end = cur.ch;
                    const currentWord = token.string.slice(0, cur.ch - token.start);
                    const list = pythonKeywords.concat(pythonBuiltins).filter(function(item) {
                        return item.startsWith(currentWord);
                    });
                    return {
                        list: list,
                        from: CodeMirror.Pos(cur.line, start),
                        to: CodeMirror.Pos(cur.line, end)
                    };
                },
                completeSingle: false
            }
        });

        // Автоматическое автодополнение при вводе
        editor.on("inputRead", function(cm, change) {
            if (!cm.state.completionActive) {
                cm.showHint({
                    hint: function(cm) {
                        const cur = cm.getCursor();
                        const token = cm.getTokenAt(cur);
                        const start = token.start;
                        const end = cur.ch;
                        const currentWord = token.string.slice(0, cur.ch - token.start);
                        const list = pythonKeywords.concat(pythonBuiltins).filter(function(item) {
                            return item.startsWith(currentWord);
                        });
                        return {
                            list: list,
                            from: CodeMirror.Pos(cur.line, start),
                            to: CodeMirror.Pos(cur.line, end)
                        };
                    },
                    completeSingle: false,
                    alignWithWord: true,
                    closeOnUnfocus: false
                });
            }
        });

        // Функции для полноэкранного режима
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function isFullScreen() {
            return !!document.fullscreenElement;
        }

        // Загрузка Pyodide
        let pyodideReady = false;
        let pyodide = null;

        async function loadPyodideAndPackages() {
            pyodide = await loadPyodide();
            pyodideReady = true;
        }

        loadPyodideAndPackages();

        // Переключение темы
        const themeToggleBtn = document.getElementById('theme-toggle');
        let darkMode = true; // Тёмная тема по умолчанию

        themeToggleBtn.addEventListener('click', () => {
            darkMode = !darkMode;
            if (darkMode) {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
                editor.setOption('theme', 'dracula');
                themeToggleBtn.textContent = 'Светлый режим';
                themeToggleBtn.classList.remove('border-gray-300', 'text-gray-700', 'dark:border-gray-700', 'dark:text-gray-300');
                themeToggleBtn.classList.add('border-gray-700', 'text-gray-300', 'dark:border-gray-300', 'dark:text-gray-700');
                // Изменение стиля вывода
                outputPre.classList.remove('bg-light', 'text-dark');
                outputPre.classList.add('bg-dark', 'text-light');
            } else {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                editor.setOption('theme', 'default');
                themeToggleBtn.textContent = 'Темный режим';
                themeToggleBtn.classList.remove('border-gray-700', 'text-gray-300', 'dark:border-gray-300', 'dark:text-gray-700');
                themeToggleBtn.classList.add('border-gray-300', 'text-gray-700', 'dark:border-gray-700', 'dark:text-gray-300');
                // Изменение стиля вывода
                outputPre.classList.remove('bg-dark', 'text-light');
                outputPre.classList.add('bg-light', 'text-dark');
            }
        });

        // Выполнение кода
        const runBtn = document.getElementById('run-btn');
        const outputPre = document.getElementById('output');
        const outputModal = document.getElementById('outputModal');
        const closeModal = document.getElementById('closeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');

        runBtn.addEventListener('click', async () => {
            if (!pyodideReady) {
                alert("Pyodide ещё загружается...");
                return;
            }
            const code = editor.getValue();
            try {
                // Экранирование обратных слэшей и кавычек
                const escapedCode = code.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
                pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = StringIO()
try:
    exec("""${escapedCode}""")
    output = sys.stdout.getvalue()
    error = sys.stderr.getvalue()
except Exception as e:
    output = ""
    error = str(e)
                `);
                const stdout = pyodide.globals.get('output');
                const stderr = pyodide.globals.get('error');
                let result = stdout;
                if (stderr) {
                    result += '\n' + stderr;
                }
                outputPre.textContent = result;
            } catch (err) {
                outputPre.textContent = err;
            }
            outputModal.classList.add('active');
        });

        // Закрытие модального окна
        closeModal.addEventListener('click', () => {
            outputModal.classList.remove('active');
        });

        closeModalBtn.addEventListener('click', () => {
            outputModal.classList.remove('active');
        });

        // Скриншот
        const screenshotBtn = document.getElementById('screenshot-btn');
        screenshotBtn.addEventListener('click', () => {
            const editorContent = editor.getWrapperElement();
            html2canvas(editorContent).then(canvas => {
                const link = document.createElement('a');
                link.download = 'screenshot.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        // Совместное использование кода
        const shareBtn = document.getElementById('share-btn');
        shareBtn.addEventListener('click', () => {
            const code = editor.getValue();
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            navigator.clipboard.writeText(url).then(() => {
                // Создание всплывающего сообщения
                const tooltip = document.createElement('div');
                tooltip.className = 'fixed bottom-5 right-5 bg-green-500 text-white px-4 py-2 rounded shadow-lg';
                tooltip.textContent = "Ссылка на код скопирована!";
                document.body.appendChild(tooltip);
                setTimeout(() => {
                    tooltip.remove();
                }, 2000);
            }).catch(err => {
                alert("Не удалось скопировать ссылку.");
            });
        });

        // Загрузка кода
        const loadBtn = document.getElementById('load-btn');
        const fileInput = document.getElementById('file-input');

        loadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.py')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    editor.setValue(e.target.result);
                };
                reader.readAsText(file);
            } else {
                alert("Пожалуйста, выберите файл с расширением .py");
            }
        });

        // Кнопка Скачать
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.addEventListener('click', () => {
            const code = editor.getValue();
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'code.py';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        // Обработка изменения размера окна для корректного отображения редактора
        window.addEventListener('resize', () => {
            editor.refresh();
        });
    </script>
</body>
</html>
